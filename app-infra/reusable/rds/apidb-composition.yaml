apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: apidb-composition
spec:
  compositeTypeRef:
    apiVersion: platform.example.org/v1alpha1
    kind: ApiDB
  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          - name: api-rds-db
            base:
              apiVersion: database.aws.crossplane.io/v1beta1
              kind: RDSInstance
              metadata:
                name: api-rds-db
              spec:
                forProvider:
                  region: us-east-1
                  engine: mysql
                  engineVersion: "8.0"
                  dbInstanceClass: db.t3.micro
                  allocatedStorage: 20
                  dbName: "example"
                  username: "admin"
                  passwordSecretRef:
                    name: example-db-instance
                    namespace: default
                    key: password
                  publiclyAccessible: false
                  skipFinalSnapshot: true
                writeConnectionSecretToRef:
                  name: connection-details
                  namespace: default
                providerConfigRef:
                  name: aws-provider-config
            patches:
               - fromFieldPath: "spec.parameters.dbName"
                 toFieldPath: "spec.forProvider.dbName"
                 type: FromCompositeFieldPath
                 policy:
                  fromFieldPath: Required
               - type: CombineFromComposite
                 combine:
                   variables:
                     - fromFieldPath: spec.parameters.dbName
                   strategy: string
                   string:
                    fmt: "%s-connection-string"
                 toFieldPath: spec.writeConnectionSecretToRef.name